# 数据链路层概述
* 数据链路层的基本服务是将数据报从一个节点沿着通信链路移动到另一个节点。
* 链路层服务的细节取决于该条链路所用的链路层协议。

![数据链路层](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.数据链路层.png)

上图为数据链路层的一个图示，数据链路层连接不同实体主机-网络层。

* 数据链路层的基本功能
	* 居家用户:通过点对点链路接入互联网
	* 公共区域:通过共享信道访问因特网

## 数据链路层模型
### 数据单位
* 数据链路层基本交换的数据单位:帧
	* 网络层通过接口把数据包交给链路层
	* 链路层把包装成本层协议规定的格式（帧）
* 为什么要分许多较小的帧且有上限？
	* 接受缓冲区大小受到限制，能确定上限
	* 传输数据越长出错可能性越大
	* 一个节点不能占用信道时间过长（数据量较大占用时间长）

![包转帧](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.包转帧.png)

上图为数据从网络层到数据链路层的转化过程，数据从报文切割成为大小相同的数据包，数据包在数据链路层运输前被封装成为大小相同的帧。

### 基本任务
* 基础:网卡物理层针对具体介质产生相应信号，完成单个比特的传输。
* 目标:根据向网络层提供的服务类型，完成一块数据的传输，并达到相应服务质量。
* 功能:把单个比特传输功能扩展成块数据的传输。

### 面临问题

![基本功能](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.基本功能.png)

上图为数据链路层必须要提供的功能，但是每个功能也有面临的问题

* 成帧问题
	* 如何识别一个帧的开始？
	* 需要一种方法表示一个帧的开始和结束。
* 差错控制
	* 帧的传输出现错误、丢失或重复怎么办？
	* 需要接收方在收到遗传二进制后的数据时判断正确性。
	* 检查发现初五时要进行相应处理。
* 流量控制
	* 如果发送方和接受方的收发处理能力不一致，出现一方快速发送另一方来不及接受怎么办？
	* 需要一种控制机制，使得能力不一致的手法双方协同发送和接受行为，保证数据帧的正确传输。
* 滑动窗口
	* 当同时有控制信息和数据信息需要发送时先发哪个？
	* 需要设计一些技术机制，尽可能提高线路的利用率，由于减低传输成本。
* 介质访问控制
	* 如果收发双方所在的网络为广播网络，即所有节点通过同一个共享介质发送和接收，谁来决定该介质使用权？
	* 必须有一套控制或仲裁机制，公平的把共享介质的贷款分配给所需要的节点，同时要兼顾广播链路的利用率。

### 问题解决
#### 流量控制
* 流量控制:用来确保发送实体发出的数据不会覆盖接受实体已接受的数据。
* 帧传输要求
	* 无丢失无差错
	* 按发出次序到达
	* 具有不等长的延时

![帧传输模型](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.帧传输模型.png)

上图为帧传输的模型，我们看到发送方编号为1的帧和2帧之间发送的时候并不是连续的，这就是帧的传播延迟。虽然帧在传输有延迟，但是具有严格的次序性。

#### 等-停流量控制
* 等-停流量控制:发送实体发送一个帧，接受实体收到后发回一个对该帧的确认，表示同意接受下一个帧;发送实体必须等待，收到确认后才能发送下一个帧。
* 链路为半双工链路连接，同时只能有一个方向的帧传输。

![等停流量控制](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.等停流量控制.png)

* 优点
	* 控制简单
	* 适当于当包被分成数量不多的帧发送，因为接收方发送每个帧都需要接受方的回复才会继续发送。
* 缺点
	* 效率不高，因为需要等待回复
	* 当一个包用多个帧发送且链路传播时延大于发送时间，每个帧的传输都需要一个双向的传播耗时。

#### 滑动窗口流量控制
* 滑动窗口控制:利用窗口控制连续发送的数据量。
* 接受方收到一个帧后fa一个确认，该确认帧包括了接收方想要的下一个帧号。
* 滑动串口控制基本条件
	* 两个节点通过全双工链路连接，即一条链路能同时有两个方向的帧进行传输。
	* 收发双方为n个帧分配缓冲区
	* 每个数据帧都有一个编号

![滑动窗口流量控制](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.滑动窗口流量控制.png)

上图为滑动窗口流量控制示意图，接受双方都有一个用于存储数据帧的缓冲区，每个帧都有自己的序号。但是问题出现，就是需要本身也占用空间，当数据帧量巨大的时候，序号占用空间巨大，怎么办？

* 序号空间：帧序号的取值范围。通常协议规定了帧格式中表示序号的二进制比特数。
* 序号空间循环特性
	* 被发送的帧按照顺序编号
	* 当用尽最大序号后下一个帧序号回滚到0

![循环序号空间](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.循环序号空间.png)

采用循环序号空间，大大减少了序号增长所占用的空间。

* 发送窗口和接受窗口
	* 发送窗口:给出允许发送方连续发送的帧序号
	* 接受窗口:给出允许接受方接受的帧序号
* 发送窗口和接收窗口可以不一样大
* 发送窗口和接收窗口沿顺时针方向滑动
* 窗口不是输出/输入缓冲区，只是发送待发送/接受帧的序号
* 窗口在收到响应的时候修改窗口帧号。
* 发送方只能发送帧号落在发送窗口内的帧，收到确认后将发送窗口向前退进。
* 接收方每收到一个帧，效验正确且序号落在接收窗口向前移动，并发出确认帧。

![发送窗口和接收窗口](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.发送窗口和接收窗口.png)

上图为发送窗口和接收窗口，我们看到发送窗口的大小为0-4，5个帧号；而接收窗口的大小为1，0开始，1个帧号。接收窗口收到发送的帧，修改接收窗口帧号，回复期待接收的下一个帧号n；在发送窗口收到接收窗口的回复以及所期待下个帧号的时候，修改发送窗口的帧号大小，下限变成接收窗口期待的帧号n，上限为（n+5）%5.

示例

![滑动窗口示例](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.滑动窗口示例.png)

上图为滑动窗口的示例，t0时刻发送窗口发送0-4的帧号数据，接收窗口准备接收编号为0的数据帧。接收到编号为0的数据帧，接收窗口修改窗口为1，并回复，期待数据编号为1给发送窗口，发送窗口收到后，修改发送窗口界限为 1-5，并发送数据。一直到t1时刻接收缓冲区准备接收编号为2的帧，发送窗口发送的数据编号为2-6.

* 捎带技术：基友数据又有确认时，将两者何在一个帧发送，即数据捎带上确认信息。

![捎带技术](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.捎带技术.png)

* 确认累计技术：为了节省宽带，接收方可对收到的k个帧（k < 发送窗口）发一个确认，告知发送方已确认接收前（k-1）帧并期待第k个帧。

![确认累计技术](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.确认累计技术.png)

注意，发送窗口移动的下限帧号为刚刚收到接收方期待接收的帧号。

#### 差错控制
* 帧传输会出现错误。

![帧出错](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.帧出错.png)

上图为帧在传输过程中出错，可能在发送方传输数据帧的时候出错，也可能在接收方回复确认帧的时候出错。

* 差错检验：指对传送的数据进行错误检测，并在发现错误时加以恰当的处理。

![差错检验](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.差错检验.png)

* 差错检验的基本功能
	* 差错检验：接收方检验入境帧是否存在误差。差错检验的基础。
	* 肯定确认：接收方成功地收到一个没有差错的帧后返回肯定确认。当没有传输错误时仅发送确认帧，可用于流量控制。
	* 超时重发：发送方在预订的时间内未收到接收方的反馈确认帧，便重发此帧。针对数据帧或确认帧丢失情况的处理，通常重发数据帧。
	* 否定确认与重发：接收方收到出错帧返回否定确认，发送方重发该帧。检验出传输错误时一般的处理方法是重发此帧。

##### 自动重发检错（ARQ）
* 纠错编码：在信息序列中提供某种规则加入一定校验码。
* 校验码：根据待传数据按某种规律生成的额外比特，用来帮助接收方检验是否发生传输错误。
* ARQ原理
	* 发送方根据被传送数据，按一定规律加入一些校验码位，使数据和校验码有某种相关性，然后将数据和校验码都发送给对方。
	* 接受方根据数据与校验码之间的相关规律进行校验，从而确定接受的数据是否出错，并通过反馈确认把检测结果告知发送方。


![ARQ](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.ARQ.png)	

##### 等停式ARQ
* 等停式ARQ：发送方仅在接受当前帧的肯定确认后才能发送下一帧。

![等停ARQ](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.等停ARQ.png)

上图为等停式ARQ,深色的数据帧为发送帧，浅色为确认帧。

* 帧被破坏：接收方丢弃出错帧，发送方超时重发。
* 帧被丢失：接收方不会有任何动作，发送方超时重发。

但是，确认帧出错会导致该确认帧的数据帧重发。怎么办？给数据帧编序号，丢弃掉重复帧并重发确认帧。

![等停ARQ处理确认帧出错](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.等停ARQ理确认帧出错.png)

* 缺点
	* 效率低下，每次有数据帧或者错误帧出错的时候都要等待超时重发。

##### 基于滑动窗口机制的ARQ

![滑动窗口ARQ](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.滑动窗口ARQ.png)

###### 回退N

![回退N](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.回退N.png)

在某一个帧出错后或者受到某个帧的重发帧后，接受方丢弃掉该帧以后该帧编号以后的所有帧，发送方需要重发错误帧以及之后的所有帧。

如果确认帧丢失了，后续的确认帧被正确接收能目标该确认帧。

![回退N累计确认](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.回退N累计确认.png)

* 基本要求
	* 要求每一帧的确认在其后第N个帧尚未接收发送之前到达（涉及到最大的缓存问题）
	* 发送方必须有存放N帧的缓存以便出错时重发
	* 接收方只需要存放一帧大小的缓冲区
	* 要求全双工链路
* 优点：消除了等停ARQ的等待确认时间。
* 缺点：正确帧的重发浪费了信道。

###### 选择重传ARQ

![选择重传ARQ](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.选择重传ARQ.png)

在选择重传ARQ中，接收方给发送方一个出错帧反馈序号，要求发送方重新发送出错的帧。出错帧的后续正确发送的帧不用重新发送，但是这样导致接受方的接受顺序出错，在接受方需要留出相同大小的缓存用于将数据帧正确排序后在上交给网络层。

同回退N策略，在确认帧出错时，后续确认帧可以累积，具有弥补作用。

* 要求
	* 发送方必须有存放N帧数据的缓存（用于数据帧出错时重发）
	* 接受方必须有足够存储空间以便缓存（N-1）个帧（用于数据帧正确排序）
	* 接受方的接受顺序可能会打乱原发送顺序
	* 要求全双工的工作链路
* 优点
	* 消除了发送方的等待确认的时间
	* 信道利用率高，不用重发正确的数据帧
* 缺点
	* 实现复杂
	* 接受方要有跟发送方相等的N个帧的缓冲区

###### 两中ARQ控制的比较

![两种ARQ控制的比较](https://github.com/zzhangyuhang/computer-network/blob/master/photo/3.两种ARQ控制的比较.png)

