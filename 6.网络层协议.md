# 网络层协议
* 网络层位于传输层和主机-网络层之间，向上层的传输层提供服务。

![网络层位置](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.网络层位置.png)

* 网络层可以提供两个维度的服务:是否面向连接，是否可靠。

![网络层提供服务](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.网络层提供服务.png)

* 网络层之间的数据传输采用的是数据包传输
	* 包带有完整地址信息
	* 途径每个路由器对包进行存储-转发处理
	* 转发时线路由路由表决定

* 网络层的功能:负责包的前进方向链路层选择和负责包的实际传输。
* 一次端对端的网络层通信由一系列的点到点传输组成。

![网络层传输流程](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.网络层传输流程.png)

上图为一个网络层的传输流程，传输采用的是存储-转发技术进行传输，在传输形式上使用的是点到点的传输。


## TCP/IP
* TCP/IP是网络层所使用的协议栈。
* TCP/IP为上层用户提供了尽力而为是不可靠的无连接包传递服务。
* TCP/IP是一个协议栈。

![TCP:IP漏斗模型](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.TCP:IP漏斗模型.png)

上图是TCP/IP协议集的漏斗模型。IP协议是主协议，只提供了传输服务，并不提供数据检错，数据修改等等的服务。所以需要一些其他协议来辅助IP协议来完成一系列的功能。

* IP协议标准
	* 全局编址，每个节点拥有唯一的IP地址(节点ID)
	* 封装和拆封，规定了如何传递上层数据(传输层报文)
	* 分段和重组，规定了包在小网络如何传输(网络互连)
* IP的主要功能:网络互连，把各种各样的局域网互连成为一个互联网络
* IP数据包的作用
	* 问题:直接用链路层的数据帧传输网络层用户的数据行吗？为什么还要中间用数据包的形式呢？
	* 答:不行！IP的作用是将各种各样的局域网互连成为一个互联网，各个局域网之间采用的协议也各不相同，因此数据格式也不一样。将一个局域网的数据传输到另一局域网中，面临的问题是数据格式不统一。解决方法是要么进行数据格式转换，要么采用更上层的更抽象的虚拟包。如果要进行数据转换，各个路由器必须了解所有链路层的协议，制定并了解数据格式转换的规则，还要花大量时间进行数据转换。如果使用更抽象的虚拟包，路由器就可以轻装工作，并不用考虑各个协议间的数据转换，只需要考虑存储-转发工作即可。这个抽象的数据包就是IP协议数据单元，简称IP包。上层用户的数据交给IP层，IP层把数据封装在本层协议单元(IP包)的有效载荷部分。然后把整个IP包交给特定的某个链路实体发送。

![IP包](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.IP包.png)

上图是IP包，IP协议将上层用户的数据封装在IP包中Payload部分中，然后交给链路层实体进行发送。只要每个用户都支持IP协议，就可以传送IP包。这样使得各个路由之间即便是各自使用的数据报文协议不同也能够完美传输，而不用考虑数据之间的转化。

### IP数据报格式

![IP数据报](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.IP数据报.png)

上图是IP的数据报结构，每个部分都有自己的作用。

* IP校验和
	* 为确保IP包传递到正确地址，必须对地址字段进行再次校验。
	* 用Header checksum进行校验，校验方法采用软件校验和计算。
		* 按16位相加
		* 结果取反
* IP服务质量

![IP服务质量](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.IP服务质量.png)

上图是IP所能提供的服务质量。每个子服务是否开启用采用0，1表示。不同的应用要求不同的服务，可以调节来完成支持。

* 生存期(Time to live)
	* IP包在网络中的生存期限，以每跳为记录单位
	* 路由器在存储-转发包时将该字段减1
	* 一个生存期为0的包将被路由器丢弃
* 协议(Protocol)
	* 接收端的网络层把包的有效载荷上交给协议字段表示的上层协议实体

![IP支持的上层协议](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.IP支持的上层协议.png)

上图是IP支持的上层协议，浅色的比较重要。

* IP选项(IP options)
	* IP在包传递过程中，可以执行某种特殊功能。默认不执行任何功能。

![IP选项](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.IP选项.png)

![可能的IP选项](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.可能的IP选项.png)

上图是可以选择的IP选项，length是IP选项的长度。

* IP协议的记录路由功能
	* 由所有处理过该数据包的路由器把自己IP地址填写入表中
	* 理由七在指针所指的位置插入自己的IP地址

![IP记录路由](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.IP路由记录.png)

* IP协议的时间戳
	* 选项包含一个记录时间空表
	* 途径的每个路由器仅在表中填入时间，可用来发现路径上发生阻塞的区域

![IP记录路由时间戳](https://github.com/zzhangyuhang/computer-network/blob/master/photo/6.IP路由记录时间戳.png)

