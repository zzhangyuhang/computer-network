# 应用层
## 网络应用结构

![网络应用结构](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.网络应用结构.png)

上面是网络应用层的大致结构示意图,网络应用主要是传输层提供服务.主要服务的协议有TCP/UDP.TCP协议典型使用的应用是浏览器/即使通讯,这些应用的特点是传输的信息必须准确可靠.UDP协议典型的应用是域名系统DNS和流媒体应用,这些应用的特点是不在乎信息的传递是否可靠,追求传输速度和响应速度.

![网络应用架构](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.网络应用架构.png)

上图是网络应用的架构,主要分为三种:1.C/S 2.B/S 3.P2P

### 客户机-服务器(C/S)

* 客户机-服务器模式特点(C/S)
	* 完成特定服务的一段程序作为常驻内存进程运行在一台机器上,等待客户机进程的请求
	* 用户端系统必须安装该网络服务的客户端程序,通过该客户进程请求服务器的服务
	* 客户机之间不直接通信

![客户机服务器架构](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.客户机服务器架构.png)

注意,客户机之间是不直接通信的.

* 服务器响应客户机请求
	* 服务器在一个众所周知的端口等待客户机的请求
	* 客户机想该服务器端口发送连接请求

![客户机申请服务过程](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.客户机申请服务过程.png)

上面是客户机申请服务过程,第一阶段:客户机与服务器建立连接;第二阶段:服务器响应客户机的请求.

![客户机申请服务流程](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.客户机申请服务流程.png)

### 浏览器-服务器(B/S)

* 用户通过浏览器使用网络服务
* 客户端的客户机进程是浏览器
* 浏览器和服务器通信协议是HTTP
* 浏览器和服务器交换的报文是HTML

![浏览器结构](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.浏览器结构.png)

上图是浏览器的结构,浏览器是一个对web的解释器,应用的协议有HTTP,FTP,SMTP,VoIP等.

* 内嵌应用
	* www
	* 流媒体应用:直播,点播
	* 网页版:电子邮件,微信,QQ

![BS架构](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.BS架构.png)

上图是B/S架构,跟C/S的区别是客户机替换成了浏览器.实际是客户端运行的进程是浏览器而已.C/S的更精确化是B/S.

* 示例:万维网(www)
	* 万维网:基于因特网的分布式信息查询系统
	* HTML:编写web页面的超文本标记语言
	* web页面:使用超文本标记语言(HTML)编写的文档
	* HTTP:浏览器与服务器通信遵守的超文本传输协议
	* 超链接:指向一个页面的文字/图标或图像

![万维网结构](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.万维网结构.png)

### 对等服务(P2P)

* 无固定的服务器
* 无固定的客户机
* 客户机直接通信
* 无集中控制中心
* 系统具有一定扩展性
* 系统管理复杂
* 典型应用
	* BitTorrent,maze
	* PPlive
	* QQ,MSN

![P2P结构](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.P2P结构.png)

### C/S和PSP实现文件共享

![CS实现文件共享](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.CS实现文件共享.png)

上图是C/S模式的文件共享,因为客户机之间不能直接共享文件,只能通过服务器来完成共享,需要共享的文件只需要在服务器加载即可.所需时间就是客户机从服务器接收数据的时间,随着客户机的数量线性增加.

![P2P实现文件共享](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.P2P实现文件共享.png)

上图是P2P模式的文件共享系统,因为客户机之间是同等的,所以需要将共享的文件传输到公众的地方进行分享.然后使用的时候再完成下载.下载的时间和C/S相等并且随着客户机的数量线性增加,但是同时客户机需要同时扩大系统容量.
	

## 网络性能
* 流:从一个源端发送到目标端的数据包流
	* 面向连接网络:流失一个连接上的全部数据包
	* 无连接网络:流是从一个进程发送到另一个进程的所有数据包
* 带宽:客户机-服务器两端通信获得的端-端数据率,单位是每秒比特数(bps)
* 时延:开始发送报文到接收报文所需要的时间,单位是秒(s)
* 抖动:接收端相邻两个报文的时延差,即前后两个时间的到达时间差,单位是秒(s)
* 丢失:接收端收到的报文和发送端发出的全部报文的比率,单位是百分比(%)

![抖动和丢失率公式](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.抖动和丢失率公式.png)

* 服务质量:一个流对网络性能的需求(带宽/时延/抖动和丢失)

![网络性能评判](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.网络性能评判.png)

注意抖动是两到达包之间的时间差,而时延则是所有的报文达到所需要的时间.

![网络应用服务质量要求](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.网络应用服务质量要求.png)

上图是网络应用服务质量要求一览,不同的应用对服务质量的需求也不一样.注意,这个高低是容忍度.视频点播可以忍受少量破防卡顿,但是不能够忍受画面跳跃.所以对带宽和抖动容忍度比较高,对延迟和丢失容忍度比较低.

## 网络流媒体应用
* 多媒体:包含两个或两个以上的媒体,通常意味着音频与视频.
	* 含图形声音文本的网页
	* 含图形图像的书籍
	* 音频/视频
* 流媒体:必须以定好的时间间隔播放的媒体
	* 音频:在线听歌/打电话
	* 视频:看录像/视频
	* 音视频:直播/可视电话
* 流媒体应用:内容涉及流媒体的应用
	* 应用模式
		* 客户机-服务器
		* 浏览器-服务器
		* 对等-对等
	* 流式:即边下载边播放.媒体播放器在播放音频/视频文件某个部分的同时下载该文件的后续部分.
		* 存储的流式音频/视频
			* 音频文件存储在服务器上供快速下载
			* 客户机可在下载完整文件前播放音视频
			* 抖动是非常重要的一个性能参数
			* 例如:视频点播(VoD)
		* 实况的流式音频/视频
			* 实时采集音频/视频信息,转换成数字形式
			* 在经过压缩后传输
			* 时延和抖动对实况转播都很重要
			* 例如:直播流媒体(体育赛事)
		* 实时交互的音频/视频
			* 具有面对面交互特性
			* 受网络时延影响较大
			* 时延和抖动对实况转播都很重要,但时延的大小至关重要
			* 例如:QQ视频电话
		* 区别
			* 存储的流式是将数据存储在服务器上,客户端根据需求进行暂停/反转/快进等操作数据流的传输,实况则不能直接快进媒体流.而实时交互则是进行网络视频/音频交流同样也不能快进.

### 音频压缩
* 数字音频:声波的数字表示,数字表示能重现音频.
* 未压缩的音频传输需要的带宽需求和传输时间目前很难满足
* 数字化和压缩式流媒体网络应用基本条件
* 编码:作用在源端,对数据进行压缩处理,以便传输
* 解码:作用在目标端,解压数据还原出原始信息
* 有损系统:解码输出引号不完全等同于原始输入信号
* 无损系统:输出信号和输入信号完全相同

### 流式媒体应用
#### 点播音频/视频(在线播放)
* 流式:媒体播放器在短暂停顿后开始播放用户请求的音视频,边播放边下载该音频文件的后续部分.
	* 服务器上的音视频文件已经被压缩好
	* 用户听/看的同事播放器下载后续内容
	* 一旦启动可连续播放

#### 通过web服务器访问音频/视频

![通过web服务器访问](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.通过web服务器访问.png)

上图是通过web服务器访问音视频,客户端通过浏览器与web服务器进行通信,服务器将文件传输给浏览器,浏览器缓存到本地磁盘,然后将本地的缓存文件调用播放器播放.播放器播放的是本地缓存的文件.这样本地需要缓存文件,浪费空间.

* 通过meta文件实现播放器与web服务器之间相连
	* Meta文件:提供了有关已流化的音频/视频文件信息(url或者编码方式)
	
![播放器直接与web服务器访问](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.播放器直接与web服务器访问.png)

上图是播放器直接与web服务器访问.在连接之前需要通过浏览器与web服务进行HTTP连接请求,然后web服务器回复meta文件给浏览器,浏览器将meta文件交给播放器.然后播放器与web服务器进行用HTTP方式直接联系.但是HTTP连接并不能支持暂停/回复/快进/跳过等操作.

* 通过引入流媒体服务器实现控制播放.
* 描述文件:包括多个连续的流莫提文件以及同步这些连续流媒体文件的指示.
	* 播放器直接向流媒体服务器请求文件
	* 播放器与媒体服务器通过专用协议通信

![播放器直接与流媒体服务器访问](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.播放器直接与流媒体服务器访问.png)

引入了流媒体服务器,使播放器直接与流媒体服务器进行连接,可以实现控制播放的功能,之间建立建立的时候需要跟之前一样需要浏览器通过HTTP协议向web服务器进行请求.web服务器回应请求一个presentation描述文件,之前是meta文件.然后浏览器将presentation描述文件下交给播放器直接与流媒体服务器进行连接.

![流媒体服务器控制播放](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.流媒体服务器控制播放.png)

上图是播放器通过RTSP协议控制流媒体的播放.

* RTSP协议:媒体播放器和流媒体服务器用来交换播放控制信息的协议.
* 带外:指存在一个独立于数据通道的额外通道.

![播放器使用RTSP协议](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.播放器使用RTSP协议.png)

播放器使用RTSP协议发送的命令是通过一个带外管道发送的,也就是单独的一条通道.RTSP协议的报文可以通过UDP/TCP发送.流媒体服务器接收到了来自客户端播放器的RTSP协议的请求来调整音视频数据.

* RTSP命令:为用户提供类似于本地播放的控制功能,包括暂停/恢复/快进/跳过等.

![RTSP协议命令](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.RTSP协议命令.png)

* RTSP协议特点
	* RTSP不负责音频/视频的压缩模式
	* RTSP不限制播放器如何缓冲音频/视频
	* RTSP不负责音频/视频的传输和封装
	* RTSP不限制流媒体的传输方式(UDP/TCP之上)

#### 播放器
* 播放器边播放流媒体边下载流媒体数据
* 媒体流数据通过流媒体传输协议从服务器传输到客户端
* 用户像播放本地音/视频一样播放流媒体
* 流媒体播放器功能
	* 有用户界面
	* 解码流媒体
	* 处理传输错误
	* 消除抖动

* 解码:播放时把数据编码文件转为模拟的音/视频信号的过程
	* 压缩过程必须设计成不管丢不丢包都能进行解码
	* 两大问题
		* 若后面的流媒体数据早于之前的数据到达客户端,则无法解压
		* 前面的数据的丢失可能导致媒体流数据无法解码
* 差错控制目的:主要克服大量丢包造成的图像不连续
	* 流媒体数据的少量丢失不会对用户体验带来太大影响
	* 网络拥塞可能带来数据突发性丢失

![播放器的差错控制](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.播放器的差错控制.png)

* 向前纠错:一种简单的纠错编码
	* 定期构造由数据包生成的奇偶包
	* 将数据包和奇偶包一起发送
	* 向前纠错的代价
		* 只有奇偶包抵达才能重构丢失包
		* 增加了额外的带宽开销

![向前纠错](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.向前纠错.png)

* 实时传输
	* 服务器以播放速度通过UDP发送音/视频,媒体播放器一旦受到媒体流立即解压播放.
	* 通过TCP(尽可能快的)发送媒体流,把到达的媒体缓存在播放缓冲区中
	* 每种媒体数据有自身的播放速度需求,为防止出现'无米可炊'的窘态,媒体播放器通常要延迟5-10秒再播放.

![接收端缓冲区](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.接收端缓冲区.png)

* 抖动消除:接收端通过延迟播放并缓冲包来消除包传输实验的变化
	* 每个包都有一个相对于媒体流中第一个样本值的时间戳
	* 播放器根据时间戳来同步音/视频流

![抖动消除](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.抖动消除.png)

* 在播放缓冲区中设立高低水印标记
* 播放器根据高低水印标记控制服务器端流媒体流数据的发送
	* 当缓冲区的媒体流数据数据量逼近高水印记时,客户端通知服务器暂停发送媒体流数据
	* 当缓冲区内的媒体流数据量少于低水印记时,客户端通知服务器回复发送媒体流数据

![缓冲区高低水印](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.缓冲区高低水印.png)

* 低水印记标记必须确保缓冲区内流媒体数据量大于2倍的网络时延*播放数率
* 高水印记标记必须确保缓冲区的剩余空间必须大于2倍的网络时延*端-端带宽

#### 流媒体数据传输协议
* 流媒体应用必须自行设计并实现用来传输流媒体数据的(应用层)协议
* 流媒体数据的传输可以基于TCP/UDP
* 标准化事实传输协议
	* 省却流媒体应用开发者的重复工作
	* 流媒体播放器和流媒体服务器可实现互相操作

* 实时传输协议(RTP):用来传输流媒体数据的协议.
	* 可支持PCM,GSM,MP3等公共语音标准
	* 可支持MPEG,H.263等公共视频标准
	* RTP不负责
		* 提供任何传输QoS保障
		* 保证媒体数据报的传输
		* 保证媒体数据报不乱序
		* 确保数据报的传输时间

* 流媒体数据作为RTP报文的有效载荷被封装在RTP报文中,然后RTP报文写入对应传输层协议的的socket中,传输层从socket中读取数据封装在自身的报文中下传给IP层.该报文又在IP层被封装成IP报文下交给主机-网络层接口层进行传输.

![RTP报文的封装和传递](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.RTP报文的封装和传递.png)

* RTP会话:来自(视频会议)多个发送端的视频和音频流都属于一个RTP会话.
	* 每个发送端可指定自己的独立音频流/视频流
	* 每个RTP包都有表示先后关系的序号
	* 每个RTP包包含一个没有播放时间点的时间戳
	* RTP没有确认,也没有请求重传的机制
	* RTP可用于一对多或者多对多通信

* RTP报文格式

![RTP报文格式](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.RTP报文格式.png)

* 实时传输控制协议(RTCP):用来想用一个RTP会话的所有成员报告发送/接收的统计信息(通过IP组播)
	* RTP的姊妹协议
	* 不携带任何音频/视频数据
	* RTCP端口号 = RTP端口号 + 1
	* 协议没有规定应用程序如何使用这些反馈信息,而是由应用程序开发者使用
* 接收端(播放器)
	* 在一个RTCP包中报告每个流的状况
		* 每个RTP流的SSRC
		* RTP流的丢失比例
		* RTP流的最后序号
		* RTP六中前后两个包的到达间隔
* 发送端(服务器)
	* 针对发送的每个流报告
		* RTP流的SSRC
		* 最近产生的RTP包的时间戳
		* 流出的报文数
		* 流出的字节数

### 网络直播流媒体
* 直播流媒体:通过网络发送实况音频和视频.
* 流媒体直播方式
	* 把节目记录到磁盘上供用户稍后点播
	* 通过网络广播实况,用户可以暂停或倒转回放媒体
* 网络直播流媒体与存储式流媒体的区别
	* 相同点
		* 用户像观看本地音/视频一样看网络直播
		* 流媒体数据的传输具有实时性要求
		* 流媒体数据的抖动会影响播放效果
	* 不同点
		* 用户只能暂停和倒退回放,不能快进
		* 实况音/视频节目只能以它产生的速率传输
		* 流媒体直播拥有的观众较多,需要网络层组播的支持
	* 直播流媒体需要更大的播放缓冲区和网络层一对多的组播支持

![直播流媒体](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.直播流媒体.png)

* 点播模式下发送速率 >= 播放速率
* 直播模式下发送速率 >= 数据产生精确速度

* 直播流媒体的组播需求
	* 流媒体直播事件涉及数百活数千个同时观看相同内容的用户
	* 服务器与客户机不再是一对一的关系
	* 组播流媒体
		* 用户主动加入某个直播组
		* 服务器将媒体包一次发给一个组地址
		* 网络将该包传递给该组内的每个组成员
	* 只要加入直播组就能接收当时的媒体流数据

![直播流媒体组播](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.直播流媒体组播.png)

* 直播流媒体的差错控制

![直播流媒体差错控制](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.直播流媒体差错控制.png)

#### 示例
* 有线电视公司提供IP电视服务.
	* IPTV利用IP包分发广播电视节目
	* 有线电视公司为流媒体分配足够的带宽
	* 机顶盒运行TCP/IP,电视机退化成显示器
	
![IPTV](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.IPTV.png)

* 个人网络电台(播客)
	* 对于拥有大量客户的大型流媒体网站,必须采用分布式的服务器模型.
	* 分发流媒体数据
	* 兼顾web服务器功能

![个人网络电台](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.个人网络电台.png)

#### 交互式流媒体
* IP语音也称为Internet电话,通过因特网实现语音通话
* 音频采集卡获取语音信号
* 经过数字化过程转换成数字
* 传输到目标端后数字还原音频
* 可以完成电脑到电话的转换,也可以电脑到电脑的转换

![IP语音](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.IP语音.png)

* 面临困难
	* 传输时延特点
		* 两点之间距离越大传输时延越大
		* 数据包长度越大传输时延越大
	* 可以通过降低包的大小来减少流媒体包的单向时延

#### IP组播
* 网络直播,多方会议均涉及一对多或多对多通信模式

![IP组播](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.IP组播.png)

* 组播数据包传递的要求
	* 组成员是动态变化的
	* 用户可任意在任何时刻加入或退出某个组
	* 寻址该组的数据报将被传递到组播中的所有成员
	* 路由器必须及时掌握组成员的变化
* 应用层组播特点
	* 网络层没有组播功能
	* 发送者对每个接受者都采用单播传输
	* 传输路径上的链路可能需要重复传输同一个组播包多次
	* 路由器按照单播方式转发每个组播包

![路由器单播转发](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.路由器单播转发.png)

* 网络层组播特点
	* 发送主机仅发送一个包
	* 一旦这个包需要转发到多条出境链路上,路由器就复制该包的副本
	* 路由器只在必要时才复制组播包
	* 路由器必须了解组成员分布并转发包
* 应用层组播和网络层组播的区别
	* 网络层组播的路由算法在网络层扔发挥着重要作用
	* 网络层组播处理组播包的路由器必须建立和维护组播连续的连接信息
	* 网络层组播如何表示组播包的接收者
	* 网络层组播如何转发给接收者
* 网络层组播转发实现
	* 源路由方式
		* 在包中列出所有接受者地址
		* 数据报中的地址信息将远远超过其有效负载中的实际数据
		* 发送者必须知道所有接受者的标识及地址
	* 间接方式组播
		* 每一组接受者有一个标识符
		* 将包传送到与该标识符相连的所有接收者

#### IP组播管理组成员-IGMP协议
* 组播管理协议:用户进程通过该协议提出加入/退出某个组的请求
	* 组播路由器通过该协议了解本地哪些足迹加入了哪些组
	* 路由器将为这些组创建组播传输所需的组播数
* 因特网组管理协议(IGMP):工作在主机与其直接相连的路由器之间.主机用它来通告他想加入某个组播组,路由器用它来发现所连网络上是否有主机属于某个组播组.
* 组播路由器功能
	* 通过IGMP协议为其每个接口维护一张组成员列表
	* 定期探寻表中成员以便确定该主机组是否仍然存在
* 直接相连路由器:第一条和最后一条路由器
* 第一条路由器:该主机到外部网络路径上的第一站
* 最后一条路由器:从外部网络到该主机路径上的最后一站

* IGMP加入一个组

![IGMP加入一个组](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.IGMP加入一个组.png)

* IGMP退出一个组

![IGMP退出一个组](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.IGMP退出一个组.png)

* IGMP报文类型

![IGMP报文类型](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.IGMP报文类型.png)

* IGMP报文封装

![IGMP报文封装](https://github.com/zzhangyuhang/computer-network/blob/master/photo/9.IGMP报文封装.png)

注意IGMP是IP提供的一种组播管理协议,所以IGMP报文被封装在IP包中.

