# 传输层协议

## 传输层与网络层服务的区别
* 网络层
	* IP协议提供了在主机之间传送包的服务,不保证任何服务质量
	* 包目的地是主机,没有对接受包的用户或应用程序进行成细致标识
* 传输层
	* 能够识别主机上的多个目的地址
	* 允许多个应用程序独立的进行数据报文的收发

![整体协议集](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.整体协议集.png)

上图是互联网的整体协议集.

## 传输层协议
* 因特网的传输层向应用层提供了两种服务:无连接的不可靠数据传输和面向连接的可靠的数据传输,将IP协议提供的主机-主机之间包传递服务扩展到端-端进程之间数据传输.
* 传输层协议主要分为TCP/UDP两种传输协议.

![传输层协议分类](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.传输层协议分类.png)

上面是传输层的协议分类,TCP主要是提供面向连接的可靠的服务.UDP则提供的是无连接的不可靠的服务.传输层无论服务可靠与否都是建立在网络层的无可靠的IP协议之上的.

* UDP
	* 将底层IP协议从客户机传递到服务器的数据交付到特定应用进程	* 将校验有错的数据报文丢弃但不采取任何弥补措施
	* 基本功能
		* 进程-进程数据传输
		* 差错检验,但是不纠错
	* 主要应用:电影音乐等流媒体应用

![UDP示例](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP示例.png)

* TCP
	* 将底层IP协议从客户机传递到服务器的数据交付到特定应用进程
	* 将校验有错的数据报文丢失,并采取相应的差错控制措施
	* 当网络出现拥塞时要及时发现并采取相应的拥塞控制措施
	* 基本功能
		* 进程-进程数据传输
		* 差错检验
		* 可靠数据传递
		* 面向连接
		* 拥塞控制
	* 主要应用:文件传输应用

![TCP示例](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.TCP示例.png)

### UDP
#### 报文格式

![UDP报文格式](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP报文格式.png)

* UDP报文的封装

![UDP报文封装](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP报文封装.png)

UDP报文中包含要传递的进程(端口号指明),UDP报文被封装在IP包中.IP包指向因特网的某台主机逻辑地址(IP地址指明).IP包被封装在链路层的帧中指向某台主机的物理地址(MAC地址指明).

#### 差错检验
* UDP提供了不可靠的无连接传输服务.它使用IP提供的服务传输报文,但增加了对给定主机上多个目标进行区别的能力.
* UDP报文可能出现丢失/重复和乱序等错误现象
* 使用UDP的应用程序需要时自行弥补UDP的不足
* 协议特点
	* 没有确认机制
	* 不对报文排序
	* 没有超时机制
	* 没有控制流量

![UDP不可靠数据通道](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP不可靠数据通道.png)

上图是UDP的不可靠通信.UDP在传输数据的时候可能会发生丢失/损坏/重复/乱序等错误.使用UDP协议进行传输的时候需要应用层补足纠错能力.

* UDP只有差错检验机制,不对传输错误做任何处理
* UDP接收端对收到报文计算校验和
* 如果校验和建设有错则丢弃报文

![UDP进行数据校验](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP进行数据校验.png)

上图是UDP进行数据校验,IP包中在接收的时候也会进行校验,但是校验则知识对IP包头内容进行校验,并没有涉及到IP的数据有效载荷部分.UDP的校验则对所有内容进行校验,提供了唯一对数据是否传送到目的地的监督.

* UDP校验和特性
	* 校验和的范围覆盖了报文头和有效载荷
	* 如果报文长度是技术用0填成偶数字节
	* 校验和为0表示发送端没有计算校验和
	* 当计算出校验和为0则用全1表示

![UDP校验和计算方法](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP校验和计算方法.png)

上面是UDP校验和计算方法,注意在UDP报文传输中没有出现错误时,接收端计算的校验和应该为全1.

* UDP伪头:仅存在于计算校验和时贴在UDP报文的前缀,不属于被传输的UDP报文.
	* 源IP地址 目标IP地址
	* IP包的协议字段
	* UDP报文长度

![UDP伪头](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP伪头.png)

上面UDP伪头的示例,在传输的时候是没有UDP伪头的,只有在计算校验和的时候才会加上.但是UDP报文长度是不包含伪头的.可以理解为在计算校验和的时候伪头起到了辅助计算的作用,但是伪头不是真正属于UDP报文.

* 伪头的设置使得UDP两次检查应用数据是否到达正确的目的地
* 长度在校验和计算中出现两次,且UDP报文长度不包含伪头
* 校验和计算完毕,传输UDP报文时要去掉伪头



