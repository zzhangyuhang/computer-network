# 传输层协议

## 传输层与网络层服务的区别
* 网络层
	* IP协议提供了在主机之间传送包的服务,不保证任何服务质量
	* 包目的地是主机,没有对接受包的用户或应用程序进行成细致标识
* 传输层
	* 能够识别主机上的多个目的地址
	* 允许多个应用程序独立的进行数据报文的收发

![整体协议集](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.整体协议集.png)

上图是互联网的整体协议集.

## 传输层协议
* 因特网的传输层向应用层提供了两种服务:无连接的不可靠数据传输和面向连接的可靠的数据传输,将IP协议提供的主机-主机之间包传递服务扩展到端-端进程之间数据传输.
* 传输层协议主要分为TCP/UDP两种传输协议.

![传输层协议分类](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.传输层协议分类.png)

上面是传输层的协议分类,TCP主要是提供面向连接的可靠的服务.UDP则提供的是无连接的不可靠的服务.传输层无论服务可靠与否都是建立在网络层的无可靠的IP协议之上的.

* UDP
	* 将底层IP协议从客户机传递到服务器的数据交付到特定应用进程	* 将校验有错的数据报文丢弃但不采取任何弥补措施
	* 基本功能
		* 进程-进程数据传输
		* 差错检验,但是不纠错
	* 主要应用:电影音乐等流媒体应用

![UDP示例](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP示例.png)

* TCP
	* 将底层IP协议从客户机传递到服务器的数据交付到特定应用进程
	* 将校验有错的数据报文丢失,并采取相应的差错控制措施
	* 当网络出现拥塞时要及时发现并采取相应的拥塞控制措施
	* 基本功能
		* 进程-进程数据传输
		* 差错检验
		* 可靠数据传递
		* 面向连接
		* 拥塞控制
	* 主要应用:文件传输应用

![TCP示例](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.TCP示例.png)

### UDP
#### 报文格式

![UDP报文格式](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP报文格式.png)

* UDP报文的封装

![UDP报文封装](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP报文封装.png)

UDP报文中包含要传递的进程(端口号指明),UDP报文被封装在IP包中.IP包指向因特网的某台主机逻辑地址(IP地址指明).IP包被封装在链路层的帧中指向某台主机的物理地址(MAC地址指明).

#### 差错检验
* UDP提供了不可靠的无连接传输服务.它使用IP提供的服务传输报文,但增加了对给定主机上多个目标进行区别的能力.
* UDP报文可能出现丢失/重复和乱序等错误现象
* 使用UDP的应用程序需要时自行弥补UDP的不足
* 协议特点
	* 没有确认机制
	* 不对报文排序
	* 没有超时机制
	* 没有控制流量

![UDP不可靠数据通道](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP不可靠数据通道.png)

上图是UDP的不可靠通信.UDP在传输数据的时候可能会发生丢失/损坏/重复/乱序等错误.使用UDP协议进行传输的时候需要应用层补足纠错能力.

* UDP只有差错检验机制,不对传输错误做任何处理
* UDP接收端对收到报文计算校验和
* 如果校验和建设有错则丢弃报文

![UDP进行数据校验](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP进行数据校验.png)

上图是UDP进行数据校验,IP包中在接收的时候也会进行校验,但是校验则知识对IP包头内容进行校验,并没有涉及到IP的数据有效载荷部分.UDP的校验则对所有内容进行校验,提供了唯一对数据是否传送到目的地的监督.

* UDP校验和特性
	* 校验和的范围覆盖了报文头和有效载荷
	* 如果报文长度是技术用0填成偶数字节
	* 校验和为0表示发送端没有计算校验和
	* 当计算出校验和为0则用全1表示

![UDP校验和计算方法](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP校验和计算方法.png)

上面是UDP校验和计算方法,注意在UDP报文传输中没有出现错误时,接收端计算的校验和应该为全1.

* UDP伪头:仅存在于计算校验和时贴在UDP报文的前缀,不属于被传输的UDP报文.
	* 源IP地址 目标IP地址
	* IP包的协议字段
	* UDP报文长度

![UDP伪头](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP伪头.png)

上面UDP伪头的示例,在传输的时候是没有UDP伪头的,只有在计算校验和的时候才会加上.但是UDP报文长度是不包含伪头的.可以理解为在计算校验和的时候伪头起到了辅助计算的作用,但是伪头不是真正属于UDP报文.

* 伪头的设置使得UDP两次检查应用数据是否到达正确的目的地
* 长度在校验和计算中出现两次,且UDP报文长度不包含伪头
* 校验和计算完毕,传输UDP报文时要去掉伪头

#### 多路复用分用和端口
* 因特网的传输层通过端口号实现应用进程的多路复用和多路分用.
* UDP多路复用和分用
	* 接收多个上层应用程序送来的数据,把数据封装成UDP数据报,下传给网络层IP协议实体传输
	* 接收下层IP协议实体送来的UDP数据报,取出包含的数据送出上层对应的应用程序

![UDP多路复用和分用](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.UDP多路复用和分用.png)

* UDP端口的管理
	* TCP/IP采纳了一种混合方式对端口地址进行管理
		* 对某些知名端口进行统一分配(0-1023)
		* 为应用程序留下了一个很大的端口取值范围
	* 管理的集中性
		* 一个管理机构负责对端口的集中分配和发布
		* 所有软件在设计时都要遵守分配规定
	* 绑定的动态性
		* 应用程序需要时由网络软件指定一个端口,即程序与端口号在生存期间动态绑定
* 为什么选择UDP?
	* 无需管理连接
		* 无需建立连接和维护连接状态
		* 没有连接省却了维护收发缓冲区,拥塞控制参数/序号和确认好等状态信息
		* 相比TCP可支持更多的客户端
	* 报头开销小
		* TCP报文头20字节长
		* UDP报文头8字节长
	* 应用程序可控制性
		* 应用进程可控制何时发送数据
		* TCP的拥塞控制机制阻止TCP的立即发送
		* TCP只能收到确认后才能发送后边的数据
		* 对于流媒体传输需要满足最小的发送速率请求
* UDP的使用场合
	* 流媒体应用(网咯电话\视频会议)可容忍少量的报文丢失,在有拥塞控制的TCP上工作很糟糕
	* 域名系统随时为客户提供名字到IP地址的映射查询服务

#### UDP协议应用-域名系统
* 域名:用来表示主机\电子邮箱\服务器等便于记忆的名字,该名字特定于某个域,具有因特网全局唯一性.
* 域名系统(DNS):将主句名/电子邮件地址/web服务器名等映射成IP地址的分布式数据库系统.
* DNS特点
	* 层次的
	* 分布式的
	* 基于自治域
* 域名具有层次结构

![DNS域名的层次机构](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.DNS域名的层次机构.png)

上图示DNS域名的层次空间,分为顶级域名-四级域名.越高等级的域名在DNS域名的最后.例如yanwei.net.pku.edu.cn,顶级域名为cn,二级域名为edu,三级域名为pku,四级域名为yanwei.net.

* 根服务器:它的管理区域是组成整棵树的服务器,这些服务器是得到授权的服务器.
	* 授权服务器
		* 域是一个行政管理空间
		* 每个域有个负责该域名空间名字授权中心
		* 域管理员负责域名空间的命名
		* 域名解析授权可由父传给子节点

![DNS域名的层次管理](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.DNS域名的层次管理.png)

DNS域名是层次管理的,本级域名由上一级域名授予和管理.

* 域名解析:给定一个域名解析出其对应的IP地址的过程
* 资源记录:给出了名字和IP地址的绑定活映射关系,是一个5元组.
	* 名字(Name)
	* 值(value)
	* 类型(type)
	* 分类(class)
	* 生存期(TTL)
* DNS服务器维护一张资源记录表,响应针对本域名子的解析请求

![DNS域名的解析](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.DNS域名的解析.png)

DNS域名的解析是通过DNS服务器里的资源记录表进行解析的,资源记录表记录了本域名名字的解析IP地址.DNS解析也是层次解析.

* DNS主要功能
	* 提供名字和地址的映射关系
	* 指向子域的DNS服务器
	* 提供各类主机别名
		* 例如:邮件服务器别名
		* 别名一般比规范名更易于记忆
		* DNS可返回对应的规范名和IP地址
	* 提供负载均很
		* 例如:www.sina.com.cn对应多个具有不同的IP地址的服务器
		* DNS数据库包括所有的IP地址
		* 每次DNS查询将获得该组IP地址单次序是循环的
	* 提供缓存
		* DNS服务器在向请求方返回查询结果时,将查询结果存储在内部的告诉缓存中.后续客户返回同样请求,则直接返回缓存结果,但是需要声明这个查询结果是来自高速缓存的.即解析结果是非授权的.
		* 非授权信息(Non-authoritative):高速缓存内的信息,曾经受到过的查询信息.

* DNS查询方式
	* 递归查询
	* 迭代查询

 ![DNS递归查询](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.DNS递归查询.png)
 
 ![DNS迭代查询](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.DNS迭代查询.png)
 
* DNS报文

 ![DNS报文头](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.DNS报文头.png)
 
上图是DNS报文头的格式.
 
  ![DNS报文正文](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.DNS报文正文.png)
  
上图是DNS报文正文.报文正文内容是可变长的,不是固定不变的.
  
   ![DNS报文传递](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.DNS报文传递.png)
   
 DNS报文传递方式并不是一成不变的用UDP进行传递.当报文问响应报文的时候且报文长度大于512字节则采用TCP协议进行传输.

### TCP
#### TCP和UDP基本功能的不同

![TCP和UDP基本功能的不同](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.TCP和UDP基本功能的不同.png)

TCP除了支持UDP支持的进程间传输和差错检验外,还支持可靠的数据传输,以及对连接的管理和拥塞的控制.

* TCP多路复用和差错检验方法和UDP相同
* TCP利用肯定确认机制对差错实行控制
* TCP的连接建立和释放均采用了"三次握手"
* TCP对网络拥塞进行了端-端的控制

#### TCP协议特性
* 因特网的传输控制协议TCP向上面的应用层提供了面向连接的可靠的端-端字节流传输服务.
* TCP协议特性
	* 连接性
		* 面向连接
			* 两个端系统维护连接状态
			* 不同于时分活频分复用
			* 不同于虚电路
		* 全双工
			* 连接是全双工的,同时双向数据传送数据
		* 点-点传输
			* 连接是点-点的,只能一对一通信(不支持一对多组播通信)
		* 客户端和服务器要建立一条逻辑通道
		* 客户机和服务器可同时向对方发送报文
		* 客户机只能和一个服务器连接并通信
	* 缓存并无边界发送
		* 有缓冲的发送
			* 应用进程交给TCP发送的数据可能需要缓冲以便和后续数据一并传输
		* 无结构数据流
			* 用TCP传输数据时不保证数据便捷,只是以字节流的形式发送
		* 应用进程通过socket发出的数据被缓存在缓冲区
		* 缓存数据何时从本地发出取决与具体TCP实现
		* 端-端之间不保留报文边界

![TCP特性](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.TCP特性.png)

上图是TCP特性示例,TCP的连接是端-端的,之间建立起一条全双工的逻辑通道,双方都可以同时收发消息给对方.同时发送的消息可以被缓存在本地并选择性发送以及示意字节流的形式发送的.

#### TCP报文格式

![TCP报文格式](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.TCP报文格式.png)

TCP报文中还拥有一部分标志位,用来控制连接行为.

![TCP报文标志位](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.TCP报文标志位.png)

* TCP段:TCP实体交换的协议数据报文
	* TCP的段独立确认
	* IP的分段不能独立确认
	* IP的分段不能独立重传
* 最大段长(MSS):TCP段允许的最大长度
* 最大段的选择
	* MSS太小降低网络利用率
	* MSS太大降低网络性能
	* 连接两端位于同一物理网络可选择MSS与MTU适应
	* 连接两端位于不同物理网络最好设置为途径网络最小MTU
	* MSS的最终确定需要连接两端协商

#### 接收数据和累计确认
* TCP接收数据特性
	* 发送端为每个字节编号
	* 采用累积确认
	* 确认号为接收端等待接收的下一个字节序号
	* 接收端缓存到达的乱序数据

![TCP累积接收数据](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.TCP累积接收数据.png)

#### 紧急数据的发送和接收
* 带外数据:不属于正常数据流并且通常具有控制功能的信息.发送端将带外数据标为紧急.
* 通过控制标志位来完成紧急数据的收发
	* URG标志位强迫TCP发送当前数据流中的所有字节
	* URG指针指出数据流中紧急数据所在
	* PSH标志位要求接受端立即执行紧急操作
	* 接收端收到紧急数据后通知响应应用程序
	* 当应用程序希望立即发送紧急数据并且另一端立即处理紧急数据时,可组合使用URG和PSH标志位以及URG指针.

![TCP紧急数据标志位](https://github.com/zzhangyuhang/computer-network/blob/master/photo/8.TCP紧急数据标志位.png)
