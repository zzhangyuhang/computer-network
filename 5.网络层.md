# 网络层
## 网络层互连一般形式

![网络层互连一般形式](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网络层互连一般形式.png)

上图是网络层互连的一般形式，每个大学的每个系通过局域网进行互连，然后在单个大学中各个院系的局域网通过交换机(网桥)完成连接。在大学与大学之间通过广域网的点对点的形式进行互连。

![网络常用互联设备](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网络常用互联设备.png)

上图是网络常用的互连设备，第一层和第二层上一章介绍过。第三层的路由器是用在远距离通信上，是点对点传输，可以容纳多个协议，支持在不同网络之间转发数据包。

![网络常用互联设备四五层](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网络常用互联设备四五层.png)

上图是网络四五层常用的互连设备。

## 路由器(Router)
### 广域网连接
* 因为整个广域网覆盖范围较广，在整个广域网上实现广播是不可能的，因此需要进行路由选择点对点的形式。

![广域网互连](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.广域网互连.png)

上图是典型的广域网中的节点互连，中间的是路由器。路由器来选择点对点的最短路径完成连接。

### 路由器
* 路由器：是一种用来连接两个运行相同/不同协议的通信子网的硬件设备，其工作在网络层。
* 特性
	* 一种用于连接两个运行相同/不同协议的中间系统
	* 针对网络层地址协议(如IP地址)进行选择和判断
	* 需要有二层地址与三层地址的映射能力(地址解析)
	* 对相同高层协议提供多个网络的互连服务

![路由器工作](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.路由器工作.png)

上图是路由器的工作示意，路由器(R1,R2,R3,R4)的每个端口连接一个通信子网，各个通信子网间可以采用不同的协议。路由器间可以协同工作，为处于各个子网的主机间的通信寻找到一条最短路径。注意：子网间的协议可以不同，路由器可以跨协议传输。

### 路由器和网桥的区别
* 网桥工作在主机-网络层

![网桥协议栈](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网桥协议栈.png)

* 路由器工作在网络层

![路由器协议栈](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.路由器协议栈.png)

* 网桥的数据处理的单位是帧
	* 网桥针对接收到的每一个数据帧，只检查帧头，并不检查或者修改帧包含的上层(网络层)的包。
	* 网桥不知道/也不需要知道帧中所使用的协议
* 路由器的数据处理单位是包
	* 检查每个包的包头，并根据包头包含的目标地址做出路由决策
	* 当将包交给下层数据链路层(网卡)转发，由网卡将包分装在以太帧或非以太帧中。

## 网络互连面临的问题

![网络互连面临问题1](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网络互连面临问题1.png)

上面列出来的问题主要是因为连个局域子网之间有可能采用的协议不同导致数据传输的方式不同引发的问题。

![网络互连面临问题2](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网络互连面临问题2.png)

上面是网络互连面临的其他类型的问题。

### 解决网络层各协议包长度不同问题
* 包的长度在传输的时候受到限制(数据报文被切割成为数据包)
	* 硬件的限制
	* 操作系统的局限
	* 协议设定
	* 减少由差错引发的重传
	* 防止某个包占用信道时间过长
* 分段技术：将大的包分成为网络能容纳的一系列段，将每一段作为一个独立的包发送。

#### 分段技术
##### 透明分段
* 透明分段：将数据包进入网络时按需分段，离开网络时恢复原样，使得前面的分段对后边的网络透明。

![透明分段](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.透明分段.png)

上图为透明分段的示例，根据每个子网采用的不同协议将数据包在入境的时候在网关中划分成为不同大小的包(段)进行传输，在出境的时候再次由网关合并成为原始的数据包交给下一个子网。

* 透明分段策略特点
	* 出口网关必须确定何时收到全部小包
	* 所有小包必须经同一个网关离开网络
	* 不断地分段与重组会增大网关开销
* 如果拆分的小包走了不同的路径，结果抵达不同出口的网关，将无法重组还原出原始包。

![透明分段的局限](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.透明分段的局限.png)

如上图，G6和G2都是出境的网关，如果一部分被分割的小包走的G2出境，一部分小包走的G6出境，两个网关所合并的数据包都不是原始完整的。

##### 不透明分段
* 不透明分段：任一中间网关都不重组，必要时只进行分段，仅在目标主机中进行一次重组。

![不透明分段](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.不透明分段.png)

如图是不透明分段的工作过程，只在必要时入境的时候进行分段，但是在包出境的时候不进行重组。只有在最终数据包传输终点的时候进行重组。任何主机都可能是终点，所以要求每个主机都能重组。重组的时候开销大，因为包被多次切割成较小的块。

##### 重组
* 一般采用树形结构编号，按照编号组成合成原始包

![按照树形结构编号的子包](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.按照树形结构编号的子包.png)

如图是按照树形结构编号的子包，当采用透明分段方法只有两层的树，因为每次切割后都要再进行一次重组，最多只有两层的树。而非透明分段方法在传输过程中可能需要多次的分割，可能产生多层。最终按照编号进行重组。

### 隧道互连技术
* 隧道：在两个端点建立传输数据报的虚拟管道，使所传输的数据报不为途径的节点所知，通常采用封装技术。

![隧道技术](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.隧道技术.png)

上图为隧道互连技术，为两个端点建立了一个用于传输数据报的虚拟管道，这个管道不被途径的节点所知，数据报不会被途经节点处理，直接到达目标节点。

## 网络层功能、作用以及服务

### 端对端通信
* 端对端通信:两个计算机系统传输实体之间的通信。
	* 网络层在其与传输层的接口为传输层提供服务。
	* 网络层是处理端对端数据传输的最底层。

![端对端通信](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.端对端通信.png)

![端对端通信内部结构](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.端对端通信内部结构.png)

上面两个图为端到端通信示意图，当应用层产生了数据交给传输层，传输层将报文交给网络层，网络层匹配最佳的传输连接，将数据包交给链路传递。

### 网络层作用
* 网络层的作用
	* 接入网络将用户数据报发送因特网
	* 网络核心完成路由选择，由链路层实现每一跳的数据传输
	* 网络层在数据包的传递中起着决定性的作用

![网络层的作用](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网络层的作用.png)

* 网络层主要是用于端对端连接。端系统间需要一种命名和一种路由选择机制。
* 路由器沿着目标方向转发数据包。

![网络层的路由选择](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网络层的路由选择.png)

上图为网络层的源端到目标端的路径，图中总共有4条路径可选。网络层必须为数据包选择出最好的那条路径。

### 网络层功能
* 网络层的功能
	* 交换/转发
	* 路由选择
	* 拥塞控制

![网络层的功能](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网络层的功能.png)

* 路由选择

![路由选择](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.路由选择.png)

* 连接建立和拥塞控制

![连接建立和拥塞控制](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.连接建立和拥塞控制.png)

### 网络层提供的服务
* 网络层提供的功能
	* 传输层是网络层的服务使用者
	* 传输层通过与网络层的接口把数据交给网络层发送
	* 网络层是传输层的服务提供者
	* 网络层把上层用户数据按照本层协议封装成包
	* 网络层通过与链路层的接口把包传递给下层发送
* 按照不同的连接方式分为
	* 面向连接
		* 当上层用户(本层的服务用户)通过接口把数据向下交给网络层时，网络层要先建立一条鱼目标节点的连接。然后把封装了数据的包往下交给链路层(本层的服务提供者)发送，相当于把包发到了该连接上。
	* 无连接
		* 当上层用户通过接口把数据向下交给网络层时，网络层直接把数据封装成本层的包，往下交给链路层发送。

![网络层服务](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.网络层服务.png)

上图是网络层提供的服务，网络层之间需要先建立连接再把数据包交给链路层完成传输，是面向连接。而不先完成连接的，直接交给链路层传输的是无连接。

### 网络层的通信模式
* 单播
	* 一对一的通信模式
	* 必须有一套全局唯一的命名规则
	* 每个网络节点有一个唯一的ID
	* 路由器处理包时根据该ID进行路由抉择

![单播](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.单播.png)

* 组播
	* 一对多的通信模式
	* 必须有一套命名一组用户的规则(组播地址)
	* 每个网络节点除有固定唯一的ID，还必须有相应组ID
	* 路由器根据组成员分布将组播包转发到组成员所在子网

![组播](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.组播.png)

* 广播
	* 一对全部的通信模式
	* 必须有一套命名全体用户的规则(广播地址)
	* 每个网络节点除有固定唯一ID外，还有相应的广播ID
	* 路由将广播包发送到一定范围的全部通信子网

![广播](https://github.com/zzhangyuhang/computer-network/blob/master/photo/5.广播.png)

注意：在发送方发送数据包的时候，路由需要根据接收方的ID选择一条好的路径完成建立转发数据包。单播的时候不需要将数据包复制为多份，接收方直接接收原始数据包即可。但是组播和广播，在接收的时候需要对原始数据包进行复制，每个接受方都有一份数据包。